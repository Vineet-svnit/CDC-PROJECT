<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/register_login.css">
    <link rel="stylesheet" href="/css/otp.css">
    <title>Verify OTP</title>
</head>

<body>
    <%- include("../includes/flash.ejs") %>
    <div class="circle orange"></div>
    <div class="circle blue"></div>
    <div id="container">
        <div class="text-center mb-4">
            <i class="fas fa-envelope-open-text" style="font-size: 48px; color: #007bff; margin-bottom: 20px;"></i>
            <h1>Verify Your Email</h1>
            <p class="mb-0">We've sent a 4-digit OTP to</p>
            <p class="fw-bold text-primary"><%= email %></p>
        </div>
        
        <div class="verification-info">
            <h5><i class="fas fa-info-circle"></i> Verification Instructions</h5>
            <ul>
                <li>Enter the 4-digit code sent to your email</li>
                <li>The code is valid for 10 minutes</li>
                <li>Check your spam folder if you don't see the email</li>
            </ul>
        </div>
        
        <form method="post" action="/verify-otp" id="otpForm">
            <input type="hidden" name="email" value="<%= email %>">
            
            <div class="otp-container">
                <input type="text" class="otp-input" name="otp1" maxlength="1" required autocomplete="off">
                <input type="text" class="otp-input" name="otp2" maxlength="1" required autocomplete="off">
                <input type="text" class="otp-input" name="otp3" maxlength="1" required autocomplete="off">
                <input type="text" class="otp-input" name="otp4" maxlength="1" required autocomplete="off">
            </div>
            
            <button type="submit" class="btn btn-dark mb-3 w-100" id="verifyBtn">
                <i class="fas fa-check-circle"></i> Verify OTP
            </button>
        </form>
        
        <div class="text-center">
            <p class="timer" id="timer">
                <i class="fas fa-clock"></i> Resend OTP in <span id="countdown">10:00</span>
            </p>
            <p class="d-none" id="resendSection">
                Didn't receive the code? 
                <span class="resend-link" onclick="resendOTP()">
                    <i class="fas fa-redo"></i> Resend OTP
                </span>
            </p>
        </div>
        
        <div class="text-center">
            <a href="/register" class="text-decoration-none">
                <i class="fas fa-arrow-left"></i> Back to Registration
            </a>
        </div>
    </div>

    <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        // OTP input handling
        const otpInputs = document.querySelectorAll('.otp-input');
        const verifyBtn = document.getElementById('verifyBtn');
        
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                
                if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
                
                // Enable/disable verify button
                updateVerifyButton();
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
            
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
                
                if (pastedData.length === 4) {
                    otpInputs.forEach((input, i) => {
                        input.value = pastedData[i] || '';
                    });
                    updateVerifyButton();
                }
            });
        });

        function updateVerifyButton() {
            const otp = Array.from(otpInputs).map(input => input.value).join('');
            verifyBtn.disabled = otp.length !== 4;
        }

        // Timer countdown
        let timeLeft = 600; // 10 minutes in seconds
        const countdownElement = document.getElementById('countdown');
        const timerElement = document.getElementById('timer');
        const resendSection = document.getElementById('resendSection');

        const timer = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                timerElement.classList.add('d-none');
                resendSection.classList.remove('d-none');
            }
            timeLeft--;
        }, 1000);

        // Resend OTP function
        async function resendOTP() {
            const resendLink = document.querySelector('.resend-link');
            const originalText = resendLink.innerHTML;
            resendLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            resendLink.style.pointerEvents = 'none';
            
            try {
                const response = await fetch('/resend-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: '<%= email %>' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> OTP has been resent to your email!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.getElementById('container').insertBefore(alertDiv, document.getElementById('container').firstChild);
                    
                    // Reset timer
                    timeLeft = 600;
                    timerElement.classList.remove('d-none');
                    resendSection.classList.add('d-none');
                    
                    // Clear OTP inputs
                    otpInputs.forEach(input => input.value = '');
                    otpInputs[0].focus();
                    updateVerifyButton();
                } else {
                    throw new Error(result.message || 'Failed to resend OTP');
                }
            } catch (error) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.getElementById('container').insertBefore(alertDiv, document.getElementById('container').firstChild);
            } finally {
                resendLink.innerHTML = originalText;
                resendLink.style.pointerEvents = 'auto';
            }
        }

        // Form submission
        document.getElementById('otpForm').addEventListener('submit', (e) => {
            const otp = Array.from(otpInputs).map(input => input.value).join('');
            if (otp.length !== 4) {
                e.preventDefault();
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> Please enter all 4 digits of the OTP
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.getElementById('container').insertBefore(alertDiv, document.getElementById('container').firstChild);
                return;
            }
            
            // Show loading state
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            verifyBtn.disabled = true;
            
            // Create hidden input with complete OTP
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'otp';
            hiddenInput.value = otp;
            e.target.appendChild(hiddenInput);
        });

        // Focus first input on page load
        window.addEventListener('load', () => {
            otpInputs[0].focus();
            updateVerifyButton();
        });
    </script>
</body>

</html>