<% layout("/layouts/userBoilerplate") %>

<%
    const nowIST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));

    const upcomingTests = [];
    const activeTests = [];
    const inactiveTests = [];

    for(let test of allTests){
        const start = new Date(test.startTime);
        const end = new Date(start.getTime() + test.duration * 60000); // duration in minutes

        if(nowIST < start){
            upcomingTests.push(test);
        } else if(nowIST >= start && nowIST <= end){
            activeTests.push(test);
        } else {
            inactiveTests.push(test);
        }
    }

    function formatDateTime(dateObj){
        const date = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Kolkata' });
        const time = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' }).toLowerCase();
        return { date, time };
    }
%>

<h2>Upcoming Tests</h2>
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1">
    <% for(let test of upcomingTests){
        const { date, time } = formatDateTime(new Date(test.startTime));
    %>
        <div class="col">
            <div class="card p-0 mt-3">
                <div class="card-header"><%= test.testName %></div>
                <div class="card-body">
                    <p class="card-text"><b>Scheduled date :</b> <%= date %></p>
                    <p class="card-text"><b>Scheduled time :</b> <%= time %></p>
                    <p class="card-text"><b>Duration :</b> <%= test.duration %></p>
                    <p class="card-text"><b>Total questions :</b> <%= test.numberOfQues %></p>
                    <p class="card-text"><b>Total marks :</b> <%= test.totalMarks %></p>
                    <a href="/tests/<%= test._id %>/<%= user._id %>" class="btn btn-primary">START TEST</a>
                </div>
            </div>
        </div>
    <% } %>
</div>

<h2>Active Tests</h2>
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1">
    <% for(let test of activeTests){
        const { date, time } = formatDateTime(new Date(test.startTime));
    %>
        <div class="col">
            <div class="card p-0 mt-3 border-success">
                <div class="card-header"><%= test.testName %></div>
                <div class="card-body">
                    <p class="card-text"><b>Scheduled date :</b> <%= date %></p>
                    <p class="card-text"><b>Scheduled time :</b> <%= time %></p>
                    <p class="card-text"><b>Duration :</b> <%= test.duration %></p>
                    <p class="card-text"><b>Total questions :</b> <%= test.numberOfQues %></p>
                    <p class="card-text"><b>Total marks :</b> <%= test.totalMarks %></p>
                    <a href="/tests/<%= test._id %>/<%= user._id %>" class="btn btn-warning">CONTINUE TEST</a>
                </div>
            </div>
        </div>
    <% } %>
</div>

<h2>Inactive / Past Tests</h2>
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1">
    <% for(let test of inactiveTests){
        const { date, time } = formatDateTime(new Date(test.startTime));
    %>
        <div class="col">
            <div class="card p-0 mt-3 border-secondary">
                <div class="card-header"><%= test.testName %></div>
                <div class="card-body">
                    <p class="card-text"><b>Scheduled date :</b> <%= date %></p>
                    <p class="card-text"><b>Scheduled time :</b> <%= time %></p>
                    <p class="card-text"><b>Duration :</b> <%= test.duration %></p>
                    <p class="card-text"><b>Total questions :</b> <%= test.numberOfQues %></p>
                    <p class="card-text"><b>Total marks :</b> <%= test.totalMarks %></p>
                    <button class="btn btn-secondary" disabled>COMPLETED</button>
                </div>
            </div>
        </div>
    <% } %>
</div>
