<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= test.testName %> - CDC</title>
    <link href="/css/question.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="item1">
            <div class="main">
                <div id="instruction">
                    <% if(questions[0]._type === "SCQ") { %>
                        <strong>Instructions:</strong> This is a Single Correct Question (SCQ). Select one correct answer.
                        <strong>Marking Scheme:</strong> +3 for correct answer, -1 for wrong answer.
                    <% } else { %>
                        <strong>Instructions:</strong> This is a Multiple Correct Question (MCQ). Select all correct answers.
                        <strong>Marking Scheme:</strong> +4 for all correct, +1 for partial correct, -1 for wrong answer.
                    <% } %>
                </div>
                <hr>
                <div class="question-container">
                    <div id="quesNum"></div>
                    <div class="ques"></div>
                </div>
                <div class="options"></div>
                <div class="button-group">
                    <button id="mark">MARK FOR REVIEW</button>
                    <button id="prev">PREVIOUS</button>
                    <button id="clear">CLEAR</button>
                    <button id="next">NEXT</button>
                </div>
            </div>
            <div class="submit-container">
                <button id="submit">SUBMIT</button>
            </div>
        </div>
        <div class="item2">
            <button id="exit">EXIT TEST</button>
            <span id="timer"></span>
            <button id="theme-toggle">
                <i id="theme-icon" class="fa-solid fa-sun"></i>
            </button>
            <div class="stats">
                <p>ATTEMPTED</p>
                <div class="at">0</div>
                <p>UNATTEMPTED</p>
                <div class="unat">
                    <%= test.questions.length %>
                </div>
                <p>MARKED FOR REVIEW</p>
                <div class="mark">0</div>
            </div>
            <div id="pallete"></div>
        </div>
    </div>

    <script>
        const startTime = new Date("<%= test.startTime.toISOString() %>");
        const endTime = new Date("<%= test.endTime.toISOString() %>");

        function updateTimer() {
            const now = new Date();
            const timeLeft = endTime - now;

            if (timeLeft <= 0) {
                alert("Time's up");
                document.getElementById("submit").click();
                return;
            }

            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById("timer").innerText =
                `${hours.toString().padStart(2, '0')}:${minutes
                    .toString().padStart(2, '0')}:${seconds
                        .toString().padStart(2, '0')}`;
        }

        setInterval(updateTimer, 1000);
        updateTimer();

        const questions = <%- JSON.stringify(test.questions) %>;
    </script>
    <script>
        const testId = "<%= test._id %>";
        const userId = "<%= user_id %>";
        let legalSubmission = false;

        document.querySelector("#submit").addEventListener("mousedown", () => {
            legalSubmission = true;
        });

        document.querySelector("#submit").addEventListener("click", async (e) => {
            await axios.post(`/submission/${testId}`, { submissions });
            legalSubmission = true;
            window.location.href = `/submission/${testId}`;
        });
        
        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === 'hidden' && !legalSubmission) {
                await axios.post(`/submission/${testId}`, { submissions });
                window.location.href = `/submission/${testId}`;
            }
        });

        document.addEventListener("contextmenu", e => e.preventDefault());
        document.onkeydown = function (e) {
            if (
                e.keyCode == 123 || // F12
                (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || // Ctrl+Shift+I/J
                (e.ctrlKey && e.keyCode == 85) // Ctrl+U
            ) {
                return false;
            }
        };
    </script>
    <script src="/js/question.js"></script>
</body>
</html>